<div class="container my-5 compras-container relatorios-page">

  <!-- Alerts -->
  <div *ngIf="successMessage" class="alert alert-success text-center" role="alert">
    {{ successMessage }}
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger text-center" role="alert"
       [innerHTML]="errorMessage">
  </div>

  <!-- Card Filtro -->
  <form [formGroup]="form" class="card compra-card border-0 mb-4">
    <div class="card-header header-ativa d-flex justify-content-between align-items-center">
      <div>
        <div class="fw-semibold">Relatórios</div>
        <div class="small opacity-75">Selecione o período e solicite o relatório.</div>
      </div>
      <span class="badge bg-light text-dark">
        Período
      </span>
    </div>

    <div class="card-body p-3 p-md-4">
      <div class="row g-3 align-items-end">

        <div class="col-12 col-md-5">
          <label class="form-label">Data inicial</label>
          <input
            type="date"
            class="form-control"
            formControlName="start"
            [class.is-invalid]="f['start'].touched && f['start'].invalid"
          />

          <div class="invalid-feedback" *ngIf="f['start'].touched && f['start'].errors?.['required']">
            A data inicial é obrigatória.
          </div>
        </div>

        <div class="col-12 col-md-5">
          <label class="form-label">Data final</label>
          <input
            type="date"
            class="form-control"
            formControlName="end"
            [class.is-invalid]="(f['end'].touched && f['end'].invalid) || (form.touched && form.errors?.['dateRangeInvalid'])"
          />

          <div class="invalid-feedback" *ngIf="f['end'].touched && f['end'].errors?.['required']">
            A data final é obrigatória.
          </div>

          <div class="invalid-feedback" *ngIf="form.touched && form.errors?.['dateRangeInvalid']">
            A data final não pode ser menor que a inicial.
          </div>
        </div>

        <div class="col-12 col-md-2 d-grid">
          <button type="button"
                  class="btn btn-primary"
                  [disabled]="form.invalid"
                  (click)="SolicitarRelatorio()">
            Solicitar
          </button>
        </div>

      </div>
    </div>
  </form>

  <!-- Card Tabela -->
  <div class="card compra-card border-0">
    <div class="card-header header-ativa d-flex justify-content-between align-items-center">
      <div>
        <div class="fw-semibold">Lista de Relatórios</div>
        <div class="small opacity-75">Resumo por produto no período selecionado.</div>
      </div>

      <span class="badge bg-light text-dark" *ngIf="relatorios?.length">
        {{ relatorios.length }} itens
      </span>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0 relatorios-table">
        <thead class="table-light">
          <tr>
            <th>Produto</th>
            <th class="text-end">Estoque</th>
            <th class="text-end">Vendidos</th>
            <th class="text-end">Canceladas</th>
            <th class="text-end">Valor Total Vendas</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let r of relatorios">
            <td class="fw-medium">{{ r.nomeProduto }}</td>
            <td class="text-end">{{ r.estoque }}</td>
            <td class="text-end">{{ r.vendidos }}</td>
            <td class="text-end">{{ r.canceladas }}</td>
            <td class="text-end fw-semibold">{{ r.valorTotal | currency:'BRL' }}</td>
          </tr>

          <tr *ngIf="!relatorios || relatorios.length === 0">
            <td colspan="5" class="text-center text-muted py-5">
              <div class="mb-2">
                <i class="bi bi-inbox fs-2"></i>
              </div>
              Nenhum relatório encontrado.
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="card-footer bg-white border-0 py-3 d-flex justify-content-end">
      <small class="text-muted">
        * Valores em BRL e consolidado por produto.
      </small>
    </div>
  </div>

</div>
